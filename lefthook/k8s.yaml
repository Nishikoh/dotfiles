lint: &lint
  parallel: true
  skip: [merge, rebase]
  commands:
    kube-score:
      files: &k8s_files |
        maybe_k8s_yaml_list=$(rg 'apiVersion:' -l $(git diff --cached --name-only))
        for file in $maybe_k8s_yaml_list; do
          kubeconform -strict $file > /dev/null
          if [ $? -eq 0 ]; then
            echo ${file}
          fi
        done
      glob: &yaml_file '*.{yaml,yml}'
      run: kube-score score {files}
    kube-linter:
      files: *k8s_files
      glob: *yaml_file
      run: kube-linter lint {files}
    trivy-k8s:
      tags: unstable
      run: trivy k8s --report summary
    helm-lint:
      files: *k8s_files
      run: helm lint {files}

pre-commit: *lint
